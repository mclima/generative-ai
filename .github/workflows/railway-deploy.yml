name: Deploy to Railway (Monorepo)

on:
  push:
    branches:
      - main
    paths:
      - 'tech-job-board/backend/**'
      - 'research-assistant/backend/**'
      - 'research-assistant/frontend/**'
      - 'stock-agent/backend/**'
      - 'newsgenie/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Note: Removed "environment: production" here to allow the job 
    # to access standard Repository Secrets for all projects.

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed projects
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            tech_job_board_backend:
              - 'tech-job-board/backend/**'
            research_assistant_backend:
              - 'research-assistant/backend/**'
            research_assistant_frontend:
              - 'research-assistant/frontend/**'
            stock_agent_backend:
              - 'stock-agent/backend/**'
            newsgenie:
              - 'newsgenie/**'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # ----------------------------
      # Tech Job Board – Backend
      # ----------------------------
      - name: Deploy tech-job-board-backend
        if: steps.changes.outputs.tech_job_board_backend == 'true'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: tech-job-board/backend
        run: |
          railway up \
            --project ${{ secrets.RAILWAY_PROJECT_ID_TECH_JOB_BOARD_BACKEND }} \
            --service 490af9cb-ab65-4431-9f67-5fdf49c0e77d \
            --environment production

      # ----------------------------
      # Research Assistant – Backend
      # ----------------------------
      - name: Deploy research-assistant-backend
        if: steps.changes.outputs.research_assistant_backend == 'true'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: research-assistant/backend
        run: |
          railway up \
            --project ${{ secrets.RAILWAY_PROJECT_ID_RESEARCH_ASSISTANT_BACKEND }} \
            --service 5e14f5e1-074f-41f9-a580-d631a87dd03c \
            --environment production

      # ----------------------------
      # Research Assistant – Frontend
      # ----------------------------
      - name: Deploy research-assistant-frontend
        if: steps.changes.outputs.research_assistant_frontend == 'true'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: research-assistant/frontend
        run: |
          railway up \
            --project ${{ secrets.RAILWAY_PROJECT_ID_RESEARCH_ASSISTANT_FRONTEND }} \
            --service 80d9f328-4dd0-47ef-a9c2-41f6ff0a4770 \
            --environment production

      # ----------------------------
      # Stock Agent – Backend
      # ----------------------------
      - name: Deploy stock-agent-backend
        if: steps.changes.outputs.stock_agent_backend == 'true'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: stock-agent/backend
        run: |
          railway up \
            --project ${{ secrets.RAILWAY_PROJECT_ID_STOCK_AGENT_BACKEND }} \
            --service bf8f1c17-fb05-47eb-9389-f81ea59d894f \
            --environment production

      # ----------------------------
      # NewsGenie
      # ----------------------------
      - name: Deploy NewsGenie
        if: steps.changes.outputs.newsgenie == 'true'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: newsgenie
        run: |
          railway up \
            --service cf6bb12a-bd6e-4d53-a692-a734b790b317 \
            --environment production