name: Railway Monorepo Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Path Filter
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            tech_job_board_backend:
              - 'tech-job-board/backend/**'
            research_assistant_backend:
              - 'research-assistant/backend/**'
            research_assistant_frontend:
              - 'research-assistant/frontend/**'
            stock_agent_backend:
              - 'stock-agent/backend/**'
            newsgenie:
              - 'newsgenie/**'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # ----------------------------
      # NewsGenie
      # ----------------------------
      - name: Deploy NewsGenie
        if: steps.changes.outputs.newsgenie == 'true'
        working-directory: newsgenie
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_NEWSGENIE }}
        run: |
          # We keep the project and service flags that fixed the auth issue
          railway up \
            --project 5defeac8-08ac-41d6-97a2-b7bdcb949576 \
            --service cf6bb12a-bd6e-4d53-a692-a734b790b317 \
            --environment production \
            --detach

      # ----------------------------
      # Stock Agent Backend
      # ----------------------------
      - name: Deploy Stock Agent Backend
        if: steps.changes.outputs.stock_agent_backend == 'true'
        working-directory: stock-agent/backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_STOCK_AGENT }}
        run: |
          railway link --project <YOUR_STOCK_AGENT_PROJECT_ID>
          railway up --service <YOUR_STOCK_AGENT_SERVICE_ID> --environment production --detach

      # ----------------------------
      # Tech Job Board Backend
      # ----------------------------
      - name: Deploy Tech Job Board
        if: steps.changes.outputs.tech_job_board_backend == 'true'
        working-directory: tech-job-board/backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_TECH_JOB }}
        run: |
          railway link --project <YOUR_TECH_JOB_PROJECT_ID>
          railway up --service <YOUR_TECH_JOB_SERVICE_ID> --environment production --detach

      # ----------------------------
      # Research Assistant Backend
      # ----------------------------
      - name: Deploy Research Assistant Backend
        if: steps.changes.outputs.research_assistant_backend == 'true'
        working-directory: research-assistant/backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_RESEARCH_BACKEND }}
        run: |
          railway link --project <YOUR_RESEARCH_BACKEND_PROJECT_ID>
          railway up --service <YOUR_RESEARCH_BACKEND_SERVICE_ID> --environment production --detach

      # ----------------------------
      # Research Assistant Frontend
      # ----------------------------
      - name: Deploy Research Assistant Frontend
        if: steps.changes.outputs.research_assistant_frontend == 'true'
        working-directory: research-assistant/frontend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_RESEARCH_FRONTEND }}
        run: |
          railway link --project <YOUR_RESEARCH_FRONTEND_PROJECT_ID>
          railway up --service <YOUR_RESEARCH_FRONTEND_SERVICE_ID> --environment production --detach